import React, { useEffect, useState } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import { Card, CardContent, CardHeader, CardTitle } from '../components/ui/card';
import { Button } from '../components/ui/button';
import { Badge } from '../components/ui/badge';
import { Input } from '../components/ui/input';
import { Label } from '../components/ui/label';
import { Textarea } from '../components/ui/textarea';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '../components/ui/select';
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger, DialogDescription, DialogFooter } from '../components/ui/dialog';
import { toast } from 'sonner';
import axios from 'axios';
import { ArrowLeft, Save, Mail, Phone, MapPin, FileText, Calendar, Upload, Download, UserPlus, X, XCircle, CheckCircle, Paperclip, Send } from 'lucide-react';
import { useAuth } from '../context/AuthContext';

const BACKEND_URL = process.env.REACT_APP_BACKEND_URL;
const API = `${BACKEND_URL}/api`;

export default function PetitionDetail() {
  const { id } = useParams();
  const navigate = useNavigate();
  const { user } = useAuth();
  const [petition, setPetition] = useState(null);
  const [loading, setLoading] = useState(true);
  const [editing, setEditing] = useState(false);
  const [editData, setEditData] = useState({});
  const [files, setFiles] = useState([]);
  const [gestores, setGestores] = useState([]);
  const [selectedGestor, setSelectedGestor] = useState('');
  const [showGestorDialog, setShowGestorDialog] = useState(false);
  const [showUploadDialog, setShowUploadDialog] = useState(false);
  const [showFinalizarDialog, setShowFinalizarDialog] = useState(false);
  const [enviarArchivosFinalizacion, setEnviarArchivosFinalizacion] = useState(false);

  useEffect(() => {
    fetchPetition();
    if (user?.role !== 'usuario') {
      fetchGestores();
    }
  }, [id]);

  const fetchPetition = async () => {
    try {
      const response = await axios.get(`${API}/petitions/${id}`);
      setPetition(response.data);
      setEditData({
        estado: response.data.estado,
        notas: response.data.notas || '',
        nombre_completo: response.data.nombre_completo,
        correo: response.data.correo,
        telefono: response.data.telefono,
        tipo_tramite: response.data.tipo_tramite,
        municipio: response.data.municipio,
        observaciones_devolucion: response.data.observaciones_devolucion || ''
      });
    } catch (error) {
      toast.error('Error al cargar la petici贸n');
      navigate('/dashboard/peticiones');
    } finally {
      setLoading(false);
    }
  };

  const fetchGestores = async () => {
    try {
      const response = await axios.get(`${API}/gestores`);
      setGestores(response.data);
    } catch (error) {
      console.error('Error fetching gestores:', error);
    }
  };

  // Funci贸n para verificar si debe mostrar di谩logo de finalizaci贸n
  const handleSaveClick = () => {
    // Si est谩 cambiando a finalizado y hay archivos del staff, mostrar di谩logo
    if (editData.estado === 'finalizado' && petition?.archivos_staff?.length > 0) {
      setShowFinalizarDialog(true);
    } else {
      handleUpdate(false);
    }
  };

  const handleUpdate = async (conArchivos = false) => {
    try {
      // Validar que si es devoluci贸n, tenga observaciones
      if (editData.estado === 'devuelto' && !editData.observaciones_devolucion?.trim()) {
        toast.error('Debe indicar las observaciones de devoluci贸n para que el usuario sepa qu茅 corregir.');
        return;
      }
      
      const updatePayload = user.role === 'coordinador' || user.role === 'administrador' ? editData : {
        estado: editData.estado,
        notas: editData.notas,
        observaciones_devolucion: editData.observaciones_devolucion
      };
      
      // Agregar flag de archivos si es finalizaci贸n
      if (editData.estado === 'finalizado') {
        updatePayload.enviar_archivos_finalizacion = conArchivos;
      }
      
      await axios.patch(`${API}/petitions/${id}`, updatePayload);
      
      // Mensaje espec铆fico para devoluci贸n
      if (editData.estado === 'devuelto') {
        toast.success('Tr谩mite devuelto. El usuario ser谩 notificado por correo con las observaciones.');
      } else {
        toast.success('隆Petici贸n actualizada exitosamente!');
      }
      
      setEditing(false);
      setShowFinalizarDialog(false);
      fetchPetition();
    } catch (error) {
      toast.error(error.response?.data?.detail || 'Error al actualizar la petici贸n');
    }
  };

  const handleFileUpload = async () => {
    if (files.length === 0) {
      toast.error('Selecciona al menos un archivo');
      return;
    }

    try {
      const formData = new FormData();
      files.forEach((file) => {
        formData.append('files', file);
      });

      await axios.post(`${API}/petitions/${id}/upload`, formData, {
        headers: {
          'Content-Type': 'multipart/form-data',
        },
      });
      
      // Si es staff interno (no usuario), autom谩ticamente finalizar el tr谩mite
      if (user?.role !== 'usuario') {
        try {
          await axios.patch(`${API}/petitions/${id}`, {
            estado: 'finalizado',
            enviar_archivos_finalizacion: true  // Enviar archivos adjuntos en el correo
          });
          toast.success('隆Documento subido y tr谩mite finalizado! Se envi贸 notificaci贸n con el archivo adjunto.');
        } catch (finalizarError) {
          toast.success('Archivos subidos exitosamente');
          toast.error('No se pudo finalizar autom谩ticamente. Por favor cambie el estado manualmente.');
        }
      } else {
        toast.success('Archivos subidos exitosamente');
      }
      
      setFiles([]);
      setShowUploadDialog(false);
      fetchPetition();
    } catch (error) {
      toast.error(error.response?.data?.detail || 'Error al subir archivos');
    }
  };

  const handleAssignGestor = async () => {
    if (!selectedGestor) {
      toast.error('Selecciona un gestor');
      return;
    }

    try {
      await axios.post(`${API}/petitions/${id}/assign-gestor`, {
        petition_id: id,
        gestor_id: selectedGestor,
        is_auxiliar: false
      });
      toast.success('Gestor asignado exitosamente');
      setShowGestorDialog(false);
      fetchPetition();
    } catch (error) {
      toast.error(error.response?.data?.detail || 'Error al asignar gestor');
    }
  };

  const handleReenviar = async () => {
    try {
      await axios.post(`${API}/petitions/${id}/reenviar`);
      toast.success('隆Petici贸n reenviada para revisi贸n! El gestor ser谩 notificado.');
      fetchPetition();
    } catch (error) {
      toast.error(error.response?.data?.detail || 'Error al reenviar la petici贸n');
    }
  };

  const getStatusBadge = (status) => {
    const statusConfig = {
      radicado: { label: 'Radicado', className: 'bg-indigo-100 text-indigo-800 border-indigo-200' },
      asignado: { label: 'Asignado', className: 'bg-yellow-100 text-yellow-800 border-yellow-200' },
      rechazado: { label: 'Rechazado', className: 'bg-red-100 text-red-800 border-red-200' },
      revision: { label: 'En Revisi贸n', className: 'bg-purple-100 text-purple-800 border-purple-200' },
      devuelto: { label: 'Devuelto', className: 'bg-orange-100 text-orange-800 border-orange-200' },
      finalizado: { label: 'Finalizado', className: 'bg-emerald-100 text-emerald-800 border-emerald-200' },
    };
    const config = statusConfig[status] || statusConfig.radicado;
    return <Badge className={config.className} data-testid="petition-status-badge">{config.label}</Badge>;
  };

  const formatDate = (dateString) => {
    return new Date(dateString).toLocaleDateString('es-ES', {
      year: 'numeric',
      month: 'long',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });
  };

  const canEdit = user?.role !== 'usuario';
  const canEditAllFields = ['coordinador', 'administrador'].includes(user?.role);
  const canAssignGestor = ['atencion_usuario', 'gestor', 'coordinador', 'administrador'].includes(user?.role);

  if (loading) {
    return (
      <div className="flex items-center justify-center h-64">
        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-emerald-700"></div>
      </div>
    );
  }

  if (!petition) {
    return null;
  }

  return (
    <div className="max-w-4xl mx-auto space-y-6" data-testid="petition-detail-page">
      <Button
        onClick={() => navigate(-1)}
        variant="ghost"
        className="text-emerald-700 hover:text-emerald-800 hover:bg-emerald-50"
        data-testid="back-button"
      >
        <ArrowLeft className="w-4 h-4 mr-2" />
        Volver
      </Button>

      {/* Header Card */}
      <Card className="border-slate-200">
        <CardHeader className="bg-gradient-to-br from-emerald-800 to-emerald-600 text-white rounded-t-lg">
          <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
            <div>
              <CardTitle className="text-2xl font-outfit" data-testid="petition-radicado">
                {petition.radicado}
              </CardTitle>
              <p className="text-emerald-100 text-sm mt-1">Detalles completos de la petici贸n</p>
            </div>
            {getStatusBadge(petition.estado)}
          </div>
        </CardHeader>
      </Card>

      {/* Alert for DEVUELTO petitions - User can resubmit */}
      {petition.estado === 'devuelto' && petition.user_id === user?.id && (
        <Card className="border-orange-300 bg-orange-50">
          <CardContent className="pt-6">
            <div className="flex items-start gap-3">
              <Send className="w-6 h-6 text-orange-600 flex-shrink-0 mt-1" />
              <div className="flex-1">
                <h3 className="text-lg font-semibold text-orange-900 mb-2">Tr谩mite Devuelto - Requiere Correcciones</h3>
                <p className="text-sm text-orange-800 mb-3">
                  Su tr谩mite ha sido devuelto por <strong>{petition.devuelto_por_nombre || 'el gestor'}</strong> para realizar correcciones. 
                  Por favor, revise las observaciones, realice los ajustes necesarios y reenv铆e para revisi贸n.
                </p>
                {petition.observaciones_devolucion && (
                  <div className="bg-white p-4 rounded-md border border-orange-200 mb-4">
                    <p className="text-sm font-medium text-slate-700 mb-2 flex items-center gap-2">
                      <Paperclip className="w-4 h-4" />
                      Observaciones del Gestor:
                    </p>
                    <p className="text-sm text-slate-900 whitespace-pre-line">{petition.observaciones_devolucion}</p>
                  </div>
                )}
                <div className="flex flex-wrap gap-3">
                  <Dialog open={showUploadDialog} onOpenChange={setShowUploadDialog}>
                    <DialogTrigger asChild>
                      <Button variant="outline" className="border-orange-400 text-orange-700 hover:bg-orange-100" data-testid="upload-correccion-button">
                        <Upload className="w-4 h-4 mr-2" />
                        Cargar Documentos
                      </Button>
                    </DialogTrigger>
                    <DialogContent>
                      <DialogHeader>
                        <DialogTitle>Subir Documentos de Correcci贸n</DialogTitle>
                      </DialogHeader>
                      <div className="space-y-4 py-4">
                        <p className="text-sm text-slate-600">
                          Sube los documentos corregidos o adicionales solicitados.
                        </p>
                        <Input
                          type="file"
                          multiple
                          onChange={(e) => setFiles(Array.from(e.target.files))}
                          data-testid="upload-files-input"
                        />
                        {files.length > 0 && (
                          <div className="space-y-2">
                            {files.map((file, idx) => (
                              <div key={idx} className="text-sm text-slate-700 flex items-center gap-2">
                                <FileText className="w-4 h-4" />
                                {file.name}
                              </div>
                            ))}
                          </div>
                        )}
                        <Button onClick={handleFileUpload} className="w-full bg-emerald-700 hover:bg-emerald-800" data-testid="confirm-upload-button">
                          Subir Archivos
                        </Button>
                      </div>
                    </DialogContent>
                  </Dialog>
                  <Button 
                    onClick={handleReenviar}
                    className="bg-orange-600 hover:bg-orange-700 text-white" 
                    data-testid="reenviar-button"
                  >
                    <Send className="w-4 h-4 mr-2" />
                    Reenviar para Revisi贸n
                  </Button>
                </div>
              </div>
            </div>
          </CardContent>
        </Card>
      )}

      {/* Alert for rejected petitions - Citizens can upload files */}
      {petition.estado === 'rechazado' && petition.user_id === user?.id && (
        <Card className="border-red-300 bg-red-50">
          <CardContent className="pt-6">
            <div className="flex items-start gap-3">
              <XCircle className="w-6 h-6 text-red-600 flex-shrink-0 mt-1" />
              <div className="flex-1">
                <h3 className="text-lg font-semibold text-red-900 mb-2">Tr谩mite Rechazado - Requiere Subsanaci贸n</h3>
                <p className="text-sm text-red-800 mb-3">
                  Su tr谩mite ha sido rechazado. Por favor, revise las notas del gestor y cargue los documentos solicitados para subsanar.
                </p>
                {petition.notas && (
                  <div className="bg-white p-3 rounded-md border border-red-200 mb-4">
                    <p className="text-sm font-medium text-slate-700 mb-1">Motivo del Rechazo:</p>
                    <p className="text-sm text-slate-900">{petition.notas}</p>
                  </div>
                )}
                <Dialog open={showUploadDialog} onOpenChange={setShowUploadDialog}>
                  <DialogTrigger asChild>
                    <Button className="bg-red-600 hover:bg-red-700 text-white" data-testid="subsanar-button">
                      <Upload className="w-4 h-4 mr-2" />
                      Cargar Documentos de Subsanaci贸n
                    </Button>
                  </DialogTrigger>
                  <DialogContent>
                    <DialogHeader>
                      <DialogTitle>Subir Documentos de Subsanaci贸n</DialogTitle>
                    </DialogHeader>
                    <div className="space-y-4 py-4">
                      <p className="text-sm text-slate-600">
                        Sube los documentos corregidos o adicionales solicitados por el gestor.
                      </p>
                      <Input
                        type="file"
                        multiple
                        onChange={(e) => setFiles(Array.from(e.target.files))}
                        data-testid="upload-files-input"
                      />
                      {files.length > 0 && (
                        <div className="space-y-2">
                          {files.map((file, idx) => (
                            <div key={idx} className="text-sm text-slate-700 flex items-center gap-2">
                              <FileText className="w-4 h-4" />
                              {file.name}
                            </div>
                          ))}
                        </div>
                      )}
                      <Button onClick={handleFileUpload} className="w-full bg-emerald-700 hover:bg-emerald-800" data-testid="confirm-upload-button">
                        Subir Archivos
                      </Button>
                    </div>
                  </DialogContent>
                </Dialog>
              </div>
            </div>
          </CardContent>
        </Card>
      )}

      {/* Actions */}
      {canEdit && !editing && (
        <div className="flex gap-3 flex-wrap">
          <Button
            onClick={() => setEditing(true)}
            className="bg-emerald-700 hover:bg-emerald-800 text-white"
            data-testid="edit-button"
          >
            Editar
          </Button>
          {canAssignGestor && (
            <Dialog open={showGestorDialog} onOpenChange={setShowGestorDialog}>
              <DialogTrigger asChild>
                <Button variant="outline" data-testid="assign-gestor-button">
                  <UserPlus className="w-4 h-4 mr-2" />
                  Asignar Gestor
                </Button>
              </DialogTrigger>
              <DialogContent>
                <DialogHeader>
                  <DialogTitle>Asignar Gestor</DialogTitle>
                </DialogHeader>
                <div className="space-y-4 py-4">
                  <Select value={selectedGestor} onValueChange={setSelectedGestor}>
                    <SelectTrigger data-testid="gestor-select">
                      <SelectValue placeholder="Selecciona un gestor" />
                    </SelectTrigger>
                    <SelectContent>
                      {gestores.map((gestor) => (
                        <SelectItem key={gestor.id} value={gestor.id}>
                          {gestor.full_name} ({gestor.role === 'gestor' ? 'Gestor' : 'Gestor Auxiliar'})
                        </SelectItem>
                      ))}
                    </SelectContent>
                  </Select>
                  <Button onClick={handleAssignGestor} className="w-full" data-testid="confirm-assign-button">
                    Asignar
                  </Button>
                </div>
              </DialogContent>
            </Dialog>
          )}
        </div>
      )}

      {/* Gestores Asignados */}
      {user?.role !== 'usuario' && (
        <Card className="border-slate-200">
          <CardHeader className="flex flex-row items-center justify-between">
            <CardTitle className="text-slate-900 font-outfit">Gestores Asignados</CardTitle>
            {/* Bot贸n auto-asignarse */}
            {['atencion_usuario', 'coordinador', 'administrador'].includes(user?.role) && 
             !petition.gestores_asignados?.includes(user?.id) && 
             petition.estado !== 'finalizado' && (
              <Button 
                variant="outline" 
                size="sm" 
                onClick={async () => {
                  try {
                    const token = localStorage.getItem('token');
                    await axios.post(`${API}/petitions/${petition.id}/auto-asignar`, {}, {
                      headers: { Authorization: `Bearer ${token}` }
                    });
                    toast.success('Te has asignado al tr谩mite');
                    fetchPetition();
                  } catch (error) {
                    toast.error(error.response?.data?.detail || 'Error al auto-asignarse');
                  }
                }}
                className="text-emerald-700 border-emerald-700 hover:bg-emerald-50"
                data-testid="auto-asignar-btn"
              >
                <UserPlus className="w-4 h-4 mr-1" />
                Asignarme
              </Button>
            )}
          </CardHeader>
          <CardContent>
            {petition.gestores_asignados && petition.gestores_asignados.length > 0 ? (
              <div className="flex flex-wrap gap-2">
                {petition.gestores_asignados.map((gestorId, idx) => {
                  const gestor = gestores.find(g => g.id === gestorId);
                  const canRemove = ['administrador', 'coordinador', 'atencion_usuario'].includes(user?.role) && 
                                   petition.estado !== 'finalizado';
                  return gestor ? (
                    <Badge 
                      key={idx} 
                      className="bg-blue-100 text-blue-800 flex items-center gap-1" 
                      data-testid={`gestor-badge-${idx}`}
                    >
                      {gestor.full_name}
                      {canRemove && (
                        <button
                          onClick={async () => {
                            if (!window.confirm(`驴Quitar a ${gestor.full_name} del tr谩mite?`)) return;
                            try {
                              const token = localStorage.getItem('token');
                              await axios.delete(`${API}/petitions/${petition.id}/desasignar/${gestorId}`, {
                                headers: { Authorization: `Bearer ${token}` }
                              });
                              toast.success(`${gestor.full_name} removido del tr谩mite`);
                              fetchPetition();
                            } catch (error) {
                              toast.error(error.response?.data?.detail || 'Error al quitar staff');
                            }
                          }}
                          className="ml-1 text-blue-600 hover:text-red-600 transition-colors"
                          data-testid={`remove-gestor-${idx}`}
                        >
                          <X className="w-3 h-3" />
                        </button>
                      )}
                    </Badge>
                  ) : null;
                })}
              </div>
            ) : (
              <p className="text-sm text-slate-500">Sin gestores asignados</p>
            )}
          </CardContent>
        </Card>
      )}

      {/* Information Card */}
      <Card className="border-slate-200">
        <CardHeader>
          <CardTitle className="text-slate-900 font-outfit">Informaci贸n del Solicitante</CardTitle>
        </CardHeader>
        <CardContent className="space-y-6">
          {editing ? (
            <div className="space-y-4">
              {/* Campos no editables - datos del solicitante */}
              <div className="bg-slate-50 p-4 rounded-lg border border-slate-200">
                <p className="text-sm font-medium text-slate-600 mb-3">Datos del Solicitante (No editables)</p>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                  <div>
                    <Label htmlFor="nombre_completo" className="text-slate-500">Nombre Completo</Label>
                    <Input
                      id="nombre_completo"
                      value={editData.nombre_completo}
                      disabled
                      className="bg-slate-100 text-slate-700 cursor-not-allowed"
                      data-testid="edit-nombre-disabled"
                    />
                  </div>
                  <div>
                    <Label htmlFor="correo" className="text-slate-500">Correo Electr贸nico</Label>
                    <Input
                      id="correo"
                      value={editData.correo}
                      disabled
                      className="bg-slate-100 text-slate-700 cursor-not-allowed"
                      data-testid="edit-correo-disabled"
                    />
                  </div>
                  <div>
                    <Label htmlFor="telefono" className="text-slate-500">Tel茅fono</Label>
                    <Input
                      id="telefono"
                      value={editData.telefono}
                      disabled
                      className="bg-slate-100 text-slate-700 cursor-not-allowed"
                      data-testid="edit-telefono-disabled"
                    />
                  </div>
                </div>
              </div>

              {/* Campos editables solo para coordinador/admin */}
              {canEditAllFields && (
                <>
                  <div>
                    <Label htmlFor="tipo_tramite">Tipo de Tr谩mite</Label>
                    <Input
                      id="tipo_tramite"
                      value={editData.tipo_tramite}
                      onChange={(e) => setEditData({ ...editData, tipo_tramite: e.target.value })}
                      data-testid="edit-tipo-tramite"
                    />
                  </div>
                  <div>
                    <Label htmlFor="municipio">Municipio</Label>
                    <Input
                      id="municipio"
                      value={editData.municipio}
                      onChange={(e) => setEditData({ ...editData, municipio: e.target.value })}
                      data-testid="edit-municipio"
                    />
                  </div>
                </>
              )}
              <div>
                <Label htmlFor="estado">Estado</Label>
                <Select value={editData.estado} onValueChange={(value) => setEditData({ ...editData, estado: value })}>
                  <SelectTrigger data-testid="edit-estado">
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="radicado">Radicado</SelectItem>
                    <SelectItem value="asignado">Asignado</SelectItem>
                    <SelectItem value="rechazado">Rechazado</SelectItem>
                    <SelectItem value="revision">En Revisi贸n</SelectItem>
                    <SelectItem value="devuelto">Devuelto</SelectItem>
                    <SelectItem value="finalizado">Finalizado</SelectItem>
                  </SelectContent>
                </Select>
              </div>
              
              {/* Campo de observaciones para devoluci贸n */}
              {editData.estado === 'devuelto' && (
                <div className="border border-orange-200 bg-orange-50 p-4 rounded-lg">
                  <Label htmlFor="observaciones_devolucion" className="text-orange-800 font-medium">
                    Observaciones de Devoluci贸n *
                  </Label>
                  <p className="text-xs text-orange-600 mb-2">
                    Indique al usuario qu茅 debe corregir para que pueda reenviar el tr谩mite.
                  </p>
                  <Textarea
                    id="observaciones_devolucion"
                    value={editData.observaciones_devolucion}
                    onChange={(e) => setEditData({ ...editData, observaciones_devolucion: e.target.value })}
                    rows={4}
                    placeholder="Ej: Falta documento de identidad del propietario. Por favor adjuntar copia legible del documento."
                    className="border-orange-300 focus:border-orange-400"
                    data-testid="edit-observaciones-devolucion"
                  />
                </div>
              )}
              
              <div>
                <Label htmlFor="notas">Notas</Label>
                <Textarea
                  id="notas"
                  value={editData.notas}
                  onChange={(e) => setEditData({ ...editData, notas: e.target.value })}
                  rows={4}
                  placeholder="Agregue notas sobre esta petici贸n..."
                  data-testid="edit-notas"
                />
              </div>
              <div className="flex gap-3">
                <Button
                  onClick={handleSaveClick}
                  className="flex-1 bg-emerald-700 hover:bg-emerald-800 text-white"
                  data-testid="save-button"
                >
                  <Save className="w-4 h-4 mr-2" />
                  Guardar Cambios
                </Button>
                <Button
                  onClick={() => setEditing(false)}
                  variant="outline"
                  className="flex-1"
                  data-testid="cancel-edit-button"
                >
                  Cancelar
                </Button>
              </div>
            </div>
          ) : (
            <div className="space-y-6">
              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div className="flex items-start gap-3">
                  <div className="p-2 bg-emerald-100 rounded-lg">
                    <FileText className="w-5 h-5 text-emerald-700" />
                  </div>
                  <div>
                    <p className="text-sm text-slate-500">Nombre Completo</p>
                    <p className="font-medium text-slate-900" data-testid="petition-nombre">{petition.nombre_completo}</p>
                  </div>
                </div>
                <div className="flex items-start gap-3">
                  <div className="p-2 bg-blue-100 rounded-lg">
                    <Mail className="w-5 h-5 text-blue-700" />
                  </div>
                  <div>
                    <p className="text-sm text-slate-500">Correo Electr贸nico</p>
                    <p className="font-medium text-slate-900" data-testid="petition-correo">{petition.correo}</p>
                  </div>
                </div>
                <div className="flex items-start gap-3">
                  <div className="p-2 bg-purple-100 rounded-lg">
                    <Phone className="w-5 h-5 text-purple-700" />
                  </div>
                  <div>
                    <p className="text-sm text-slate-500">Tel茅fono</p>
                    <p className="font-medium text-slate-900" data-testid="petition-telefono">{petition.telefono}</p>
                  </div>
                </div>
                <div className="flex items-start gap-3">
                  <div className="p-2 bg-orange-100 rounded-lg">
                    <MapPin className="w-5 h-5 text-orange-700" />
                  </div>
                  <div>
                    <p className="text-sm text-slate-500">Municipio</p>
                    <p className="font-medium text-slate-900" data-testid="petition-municipio">{petition.municipio}</p>
                  </div>
                </div>
              </div>

              <div className="border-t border-slate-200 pt-6">
                <div className="flex items-start gap-3">
                  <div className="p-2 bg-emerald-100 rounded-lg">
                    <FileText className="w-5 h-5 text-emerald-700" />
                  </div>
                  <div className="flex-1">
                    <p className="text-sm text-slate-500">Tipo de Tr谩mite</p>
                    <p className="font-medium text-slate-900" data-testid="petition-tipo-tramite">{petition.tipo_tramite}</p>
                  </div>
                </div>
              </div>

              {petition.notas && (
                <div className="border-t border-slate-200 pt-6">
                  <p className="text-sm text-slate-500 mb-2">Notas</p>
                  <p className="text-slate-900" data-testid="petition-notas">{petition.notas}</p>
                </div>
              )}

              <div className="border-t border-slate-200 pt-6">
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                  <div className="flex items-center gap-2">
                    <Calendar className="w-4 h-4 text-slate-500" />
                    <div>
                      <p className="text-slate-500">Creada</p>
                      <p className="font-medium text-slate-900" data-testid="petition-created-at">{formatDate(petition.created_at)}</p>
                    </div>
                  </div>
                  <div className="flex items-center gap-2">
                    <Calendar className="w-4 h-4 text-slate-500" />
                    <div>
                      <p className="text-slate-500">ltima actualizaci贸n</p>
                      <p className="font-medium text-slate-900" data-testid="petition-updated-at">{formatDate(petition.updated_at)}</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          )}
        </CardContent>
      </Card>

      {/* Files Card */}
      <Card className="border-slate-200">
        <CardHeader>
          <div className="flex justify-between items-center">
            <CardTitle className="text-slate-900 font-outfit">Documentos Adjuntos</CardTitle>
            <div className="flex gap-2">
              {/* Bot贸n para ciudadanos: subir archivos propios */}
              {petition.user_id === user?.id && (
                <Dialog open={showUploadDialog} onOpenChange={setShowUploadDialog}>
                  <DialogTrigger asChild>
                    <Button variant="outline" size="sm" data-testid="upload-more-button">
                      <Upload className="w-4 h-4 mr-2" />
                      Subir M谩s
                    </Button>
                  </DialogTrigger>
                  <DialogContent>
                    <DialogHeader>
                      <DialogTitle>Subir Archivos</DialogTitle>
                    </DialogHeader>
                    <div className="space-y-4 py-4">
                      <Input
                        type="file"
                        multiple
                        onChange={(e) => setFiles(Array.from(e.target.files))}
                        data-testid="upload-files-input"
                      />
                      {files.length > 0 && (
                        <div className="space-y-2">
                          {files.map((file, idx) => (
                            <div key={idx} className="text-sm text-slate-700">{file.name}</div>
                          ))}
                        </div>
                      )}
                      <Button onClick={handleFileUpload} className="w-full" data-testid="confirm-upload-button">
                        Subir Archivos
                      </Button>
                    </div>
                  </DialogContent>
                </Dialog>
              )}
              {/* Bot贸n para personal: subir archivos finales (solo en modo edici贸n o siempre visible) */}
              {user?.role !== 'usuario' && petition.user_id !== user?.id && (
                <Dialog open={showUploadDialog} onOpenChange={setShowUploadDialog}>
                  <DialogTrigger asChild>
                    <Button variant="outline" size="sm" data-testid="staff-upload-button">
                      <Upload className="w-4 h-4 mr-2" />
                      Subir Documento Final
                    </Button>
                  </DialogTrigger>
                  <DialogContent>
                    <DialogHeader>
                      <DialogTitle>Subir Documento Final</DialogTitle>
                    </DialogHeader>
                    <div className="space-y-4 py-4">
                      <div className="bg-emerald-50 border border-emerald-200 rounded-lg p-3">
                        <p className="text-sm text-emerald-800 font-medium">
                          锔 Al subir el documento, el tr谩mite se finalizar谩 autom谩ticamente y se enviar谩 una notificaci贸n por correo al solicitante con el archivo adjunto.
                        </p>
                      </div>
                      <Input
                        type="file"
                        multiple
                        onChange={(e) => setFiles(Array.from(e.target.files))}
                        data-testid="staff-upload-input"
                      />
                      {files.length > 0 && (
                        <div className="space-y-2">
                          {files.map((file, idx) => (
                            <div key={idx} className="text-sm text-slate-700 flex items-center gap-2">
                              <FileText className="w-4 h-4" />
                              {file.name}
                            </div>
                          ))}
                        </div>
                      )}
                      <Button onClick={handleFileUpload} className="w-full bg-emerald-700 hover:bg-emerald-800" data-testid="confirm-staff-upload">
                        Subir y Finalizar Tr谩mite
                      </Button>
                    </div>
                  </DialogContent>
                </Dialog>
              )}
              {user?.role !== 'usuario' && petition.archivos && petition.archivos.some(a => !a.uploaded_by_role || a.uploaded_by_role === 'usuario') && (
                <Button
                  variant="outline"
                  size="sm"
                  onClick={async () => {
                    try {
                      const response = await axios.get(`${API}/petitions/${id}/download-zip`, {
                        responseType: 'blob'
                      });
                      const url = window.URL.createObjectURL(new Blob([response.data]));
                      const link = document.createElement('a');
                      link.href = url;
                      link.setAttribute('download', `${petition.radicado}_archivos.zip`);
                      document.body.appendChild(link);
                      link.click();
                      link.remove();
                      window.URL.revokeObjectURL(url);
                      toast.success('ZIP descargado exitosamente');
                    } catch (error) {
                      toast.error(error.response?.data?.detail || 'Error al descargar ZIP');
                    }
                  }}
                  data-testid="download-zip-button"
                >
                  <Download className="w-4 h-4 mr-2" />
                  Descargar ZIP (Usuario)
                </Button>
              )}
            </div>
          </div>
        </CardHeader>
        <CardContent>
          {petition.archivos && petition.archivos.length > 0 ? (
            <div className="space-y-2">
              {petition.archivos.map((archivo, idx) => {
                const uploadedByRole = archivo.uploaded_by_role || 'usuario';
                const isCitizen = uploadedByRole === 'usuario';
                const badgeColor = isCitizen ? 'bg-blue-100 text-blue-800' : 'bg-emerald-100 text-emerald-800';
                const roleLabel = isCitizen ? 'Usuario' : 'Personal';
                
                return (
                  <div key={idx} className="flex items-center justify-between p-3 bg-slate-50 rounded-md border border-slate-200" data-testid={`file-${idx}`}>
                    <div className="flex items-center gap-3 flex-1">
                      <FileText className="w-4 h-4 text-slate-500" />
                      <div className="flex-1">
                        <p className="text-sm font-medium text-slate-700">{archivo.original_name}</p>
                        {archivo.uploaded_by_name && (
                          <p className="text-xs text-slate-500">
                            Subido por: {archivo.uploaded_by_name}
                            {archivo.upload_date && ` - ${new Date(archivo.upload_date).toLocaleDateString('es-ES')}`}
                          </p>
                        )}
                      </div>
                      <Badge className={badgeColor}>{roleLabel}</Badge>
                    </div>
                  </div>
                );
              })}
            </div>
          ) : (
            <p className="text-sm text-slate-500">No hay archivos adjuntos</p>
          )}
        </CardContent>
      </Card>

      {/* Historial Card */}
      <Card className="border-slate-200">
        <CardHeader>
          <CardTitle className="text-slate-900 font-outfit">Historial del Tr谩mite</CardTitle>
        </CardHeader>
        <CardContent>
          {petition.historial && petition.historial.length > 0 ? (
            <div className="relative space-y-6" data-testid="historial-timeline">
              {/* Timeline line */}
              <div className="absolute left-4 top-0 bottom-0 w-0.5 bg-slate-200"></div>
              
              {petition.historial.map((entry, idx) => {
                const fecha = new Date(entry.fecha);
                const fechaFormateada = fecha.toLocaleDateString('es-ES', {
                  year: 'numeric',
                  month: 'short',
                  day: 'numeric',
                  hour: '2-digit',
                  minute: '2-digit'
                });
                
                // Determine icon and color based on action
                let IconComponent = Calendar;
                let iconBgColor = 'bg-blue-100';
                let iconColor = 'text-blue-600';
                
                if (entry.accion.includes('Radicado')) {
                  IconComponent = FileText;
                  iconBgColor = 'bg-indigo-100';
                  iconColor = 'text-indigo-600';
                } else if (entry.accion.includes('asignado') || entry.accion.includes('Asignado')) {
                  IconComponent = UserPlus;
                  iconBgColor = 'bg-yellow-100';
                  iconColor = 'text-yellow-600';
                } else if (entry.estado_nuevo === 'finalizado') {
                  IconComponent = CheckCircle;
                  iconBgColor = 'bg-emerald-100';
                  iconColor = 'text-emerald-600';
                } else if (entry.estado_nuevo === 'rechazado') {
                  IconComponent = XCircle;
                  iconBgColor = 'bg-red-100';
                  iconColor = 'text-red-600';
                } else if (entry.accion.includes('archivos') || entry.accion.includes('Archivos')) {
                  IconComponent = Upload;
                  iconBgColor = 'bg-purple-100';
                  iconColor = 'text-purple-600';
                }
                
                return (
                  <div key={idx} className="relative flex gap-4 pl-10" data-testid={`historial-entry-${idx}`}>
                    {/* Timeline dot/icon */}
                    <div className={`absolute left-0 ${iconBgColor} p-2 rounded-full`}>
                      <IconComponent className={`w-4 h-4 ${iconColor}`} />
                    </div>
                    
                    {/* Content */}
                    <div className="flex-1 pb-6">
                      <div className="bg-slate-50 rounded-lg p-4 border border-slate-200">
                        <div className="flex justify-between items-start mb-2">
                          <p className="font-medium text-slate-900">{entry.accion}</p>
                          <span className="text-xs text-slate-500">{fechaFormateada}</span>
                        </div>
                        <p className="text-sm text-slate-600 mb-1">
                          Por: <span className="font-medium">{entry.usuario}</span>
                          <span className="text-xs text-slate-500 ml-2">
                            ({entry.usuario_rol === 'atencion_usuario' ? 'Atenci贸n al Usuario' : 
                              entry.usuario_rol === 'gestor_auxiliar' ? 'Gestor Auxiliar' : 
                              entry.usuario_rol.charAt(0).toUpperCase() + entry.usuario_rol.slice(1)})
                          </span>
                        </p>
                        {entry.notas && (
                          <p className="text-sm text-slate-700 mt-2 p-2 bg-white rounded border border-slate-200">
                            {entry.notas}
                          </p>
                        )}
                      </div>
                    </div>
                  </div>
                );
              })}
            </div>
          ) : (
            <p className="text-sm text-slate-500">No hay historial disponible</p>
          )}
        </CardContent>
      </Card>

      {/* Di谩logo de confirmaci贸n de finalizaci贸n */}
      <Dialog open={showFinalizarDialog} onOpenChange={setShowFinalizarDialog}>
        <DialogContent className="sm:max-w-md">
          <DialogHeader>
            <DialogTitle className="flex items-center gap-2 text-emerald-700">
              <CheckCircle className="w-5 h-5" />
              Finalizar Tr谩mite
            </DialogTitle>
            <DialogDescription>
              El tr谩mite ser谩 marcado como finalizado y se notificar谩 al solicitante por correo electr贸nico.
            </DialogDescription>
          </DialogHeader>
          
          {petition?.archivos_staff?.length > 0 && (
            <div className="bg-amber-50 border border-amber-200 rounded-lg p-4 my-4">
              <div className="flex items-start gap-3">
                <Paperclip className="w-5 h-5 text-amber-600 mt-0.5" />
                <div>
                  <p className="font-medium text-amber-800">
                    Archivos disponibles para enviar
                  </p>
                  <p className="text-sm text-amber-700 mt-1">
                    Has cargado {petition.archivos_staff.length} archivo(s) de respuesta. 
                    驴Deseas enviarlos adjuntos en el correo de finalizaci贸n?
                  </p>
                  <ul className="mt-2 text-xs text-amber-600 space-y-1">
                    {petition.archivos_staff.slice(0, 3).map((archivo, idx) => (
                      <li key={idx} className="truncate"> {archivo.filename}</li>
                    ))}
                    {petition.archivos_staff.length > 3 && (
                      <li>... y {petition.archivos_staff.length - 3} m谩s</li>
                    )}
                  </ul>
                </div>
              </div>
            </div>
          )}
          
          <DialogFooter className="flex flex-col sm:flex-row gap-2 mt-4">
            <Button
              variant="outline"
              onClick={() => setShowFinalizarDialog(false)}
              className="flex-1"
            >
              Cancelar
            </Button>
            {petition?.archivos_staff?.length > 0 ? (
              <>
                <Button
                  variant="outline"
                  onClick={() => handleUpdate(false)}
                  className="flex-1 border-emerald-300 text-emerald-700 hover:bg-emerald-50"
                >
                  <Send className="w-4 h-4 mr-2" />
                  Solo Notificar
                </Button>
                <Button
                  onClick={() => handleUpdate(true)}
                  className="flex-1 bg-emerald-700 hover:bg-emerald-800 text-white"
                >
                  <Paperclip className="w-4 h-4 mr-2" />
                  Notificar + Archivos
                </Button>
              </>
            ) : (
              <Button
                onClick={() => handleUpdate(false)}
                className="flex-1 bg-emerald-700 hover:bg-emerald-800 text-white"
              >
                <Send className="w-4 h-4 mr-2" />
                Finalizar y Notificar
              </Button>
            )}
          </DialogFooter>
        </DialogContent>
      </Dialog>
    </div>
  );
}
